{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Master Template",
  "Parameters": {
    "ProjectName": {
      "Type": "String",
      "Description": "App Name.",
      "Default": "project"
    },
    "Environment": {
      "Type": "String",
      "Description": "Environment name."
    },
    "BucketArtifactName": {
      "Type": "String",
      "Description": "Bucket where all artifacts will be saved.",
      "Default": ""
    }
  },
  "Resources": {
    "Role": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:DescribeLogStreams",
                    "logs:PutLogEvents"
                  ],
                  "Resource": {
                    "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:*"
                  }
                }
              ]
            },
            "PolicyName": {
              "Fn::Sub": "${Environment}-${ProjectName}-lambdaLogPermission"
            }
          },
          {
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "ec2:DescribeNetworkInterfaces",
                    "ec2:CreateNetworkInterface",
                    "ec2:DeleteNetworkInterface",
                    "ec2:DescribeInstances",
                    "ec2:AttachNetworkInterface"
                  ],
                  "Resource": "*"
                }
              ]
            },
            "PolicyName": {
              "Fn::Sub": "${Environment}-${ProjectName}-lambdaVpcPermission"
            }
          },
          {
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "ssm:GetParameters",
                    "ssm:GetParameter"
                  ],
                  "Resource": {
                    "Fn::Sub": "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*"
                  }
                }
              ]
            },
            "PolicyName": {
              "Fn::Sub": "${Environment}-${ProjectName}-lambdaSSMPermission"
            }
          },
          {
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "states:StartExecution",
                    "states:StartSyncExecution"
                  ],
                  "Resource": {
                    "Fn::Sub": "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:*"
                  }
                }
              ]
            },
            "PolicyName": {
              "Fn::Sub": "${Environment}-${ProjectName}-lambdaStateMachinePermission"
            }
          },
          {
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "dynamodb:DescribeStream",
                    "dynamodb:GetRecords",
                    "dynamodb:GetShardIterator",
                    "dynamodb:ListStreams",
                    "dynamodb:UpdateItem"
                  ],
                  "Resource": {
                    "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/*"
                  }
                }
              ]
            },
            "PolicyName": {
              "Fn::Sub": "${Environment}-${ProjectName}-lambdaDynamoDBStreamPermission"
            }
          },
          {
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "apigateway:GET",
                  "Resource": [
                    "arn:aws:apigateway:*::/restapis/*/deployments/*",
                    "arn:aws:apigateway:*::/restapis/*/stages/*",
                    "arn:aws:apigateway:*::/apikeys/*",
                    "arn:aws:apigateway:*::/usageplans",
                    "arn:aws:apigateway:*::/apikeys",
                    "arn:aws:apigateway:*::/restapis/*/deployments",
                    "arn:aws:apigateway:*::/usageplans/*/keys/*",
                    "arn:aws:apigateway:*::/restapis/*/stages",
                    "arn:aws:apigateway:*::/usageplans/*/keys"
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "apigateway:GET"
                  ],
                  "Resource": [
                    "arn:aws:apigateway:*::/usageplans/*"
                  ]
                }
              ]
            },
            "PolicyName": {
              "Fn::Sub": "${Environment}-${ProjectName}-lambdaUsagePlanPermission"
            }
          },
          {
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "secretsmanager:GetResourcePolicy",
                    "secretsmanager:GetSecretValue",
                    "secretsmanager:DescribeSecret",
                    "secretsmanager:ListSecretVersionIds"
                  ],
                  "Resource": {
                    "Fn::Sub": "arn:aws:secretsmanager:*:${AWS::AccountId}:secret:*"
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "secretsmanager:GetRandomPassword",
                    "secretsmanager:ListSecrets"
                  ],
                  "Resource": "*"
                }
              ]
            },
            "PolicyName": {
              "Fn::Sub": "${Environment}-${ProjectName}-lambdaSecretsManagerPermission"
            }
          },
          {
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "kms:*",
                  "Resource": "*"
                }
              ]
            },
            "PolicyName": {
              "Fn::Sub": "${Environment}-${ProjectName}-lambdaKmsPermission"
            }
          },
          {
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "sqs:*"
                  ],
                  "Resource": {
                    "Fn::Sub": "arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:*"
                  }
                }
              ]
            },
            "PolicyName": {
              "Fn::Sub": "${Environment}-${ProjectName}-lambdaSqsPermission"
            }
          },
          {
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "xray:PutTraceSegments",
                    "xray:PutTelemetryRecords"
                  ],
                  "Resource": "*"
                }
              ]
            },
            "PolicyName": {
              "Fn::Sub": "${Environment}-${ProjectName}-x-ray-access"
            }
          },
          {
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:*",
                    "s3-object-lambda:*"
                  ],
                  "Resource": "*"
                }
              ]
            },
            "PolicyName": {
              "Fn::Sub": "${Environment}-${ProjectName}-s3-log-access"
            }
          }
        ]
      }
    },
    "LmdGetTest": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": "../src/lambdas/get_test",
        "Handler": "lambda_function.lambda_handler",
        "Role": {
          "Fn::GetAtt": [
            "Role",
            "Arn"
          ]
        },
        "Runtime": "python3.9",
        "TracingConfig": {
          "Mode": "Active"
        },
        "FunctionName": {
          "Fn::Sub": "${Environment}-${ProjectName}-get_test"
        },
        "MemorySize": 128,
        "Timeout": 30
      }
    }
  }
}